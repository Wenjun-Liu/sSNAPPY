<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>sSNAPPY: Singel Sample directioNAl Pathway Perturbation analYsis • sSNAPPY</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/Sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="sSNAPPY: Singel Sample directioNAl Pathway Perturbation analYsis">
<meta property="og:description" content="sSNAPPY">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">sSNAPPY</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.99.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/SSPT.html">Get Started</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="sSNAPPY_files/htmlwidgets-1.5.4/htmlwidgets.js"></script><link href="sSNAPPY_files/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="sSNAPPY_files/datatables-binding-0.21/datatables.js"></script><link href="sSNAPPY_files/dt-core-1.11.3/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="sSNAPPY_files/dt-core-1.11.3/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="sSNAPPY_files/dt-core-1.11.3/js/jquery.dataTables.min.js"></script><link href="sSNAPPY_files/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="sSNAPPY_files/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="sSNAPPY_files/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="sSNAPPY_files/selectize-0.12.0/selectize.min.js"></script><link href="sSNAPPY_files/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="sSNAPPY_files/crosstalk-1.2.0/js/crosstalk.min.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>sSNAPPY: Singel Sample directioNAl Pathway
Perturbation analYsis</h1>
                        <h4 data-toc-skip class="author">Wenjun Nora
Liu</h4>
                  <a class="author_email" href="mailto:#"></a><a href="mailto:wenjun.liu@adelaide.edu.au" class="email">wenjun.liu@adelaide.edu.au</a>
      
                  
      
      
      <div class="hidden name"><code>sSNAPPY.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette demonstrates how to use the package
<code>sSNAPPY</code> to compute directional single sample pathway
perturbation scores by incorporating pathway topologies, utilize sample
permutation to test the significance of individual scores and compare
average pathway activities across treatment.</p>
<p>The package also provides a function to visualize overlap between
pathway genes contained in perturbed biological pathways as network
plots.</p>
</div>
<div class="section level2">
<h2 id="install-ssnappy-package-from-bioconductor">Install <code>sSNAPPY</code> package from
<code>Bioconductor</code><a class="anchor" aria-label="anchor" href="#install-ssnappy-package-from-bioconductor"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"BiocManager"</span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"BiocManager"</span><span class="op">)</span>
<span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocManager/man/install.html" class="external-link">install</a></span><span class="op">(</span><span class="st">"sSNAPPY"</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wenjun-liu.github.io/SSPT/">sSNAPPY</a></span><span class="op">)</span></code></pre></div>
<p>Load the other packages used in this tutorial.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org" class="external-link">magrittr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rstudio/DT" class="external-link">DT</a></span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="load-data">load data<a class="anchor" aria-label="anchor" href="#load-data"></a>
</h2>
<p>The example dataset used for this tutorial has been built into the
<code>sSNAPPY</code> package. It’s a subset of data retrieved from <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4928895/" class="external-link">Singhal H
et al. 2016</a>, where ER-positive primary breast cancer tumor tissues
collected from 12 patients were split into fragments of equal sizes for
different treatments. For the purpose of this tutorial, we only took the
RNA-seq data from samples treated with vehicle, E2 OR E2 + R5020 from
each patient. More detailed description of the dataset can be assessed
through the help page (<code><a href="../reference/logCPM_example.html">?logCPM_example</a></code> and
<code><a href="../reference/metadata_example.html">?metadata_example</a></code>).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># check if samples included in the logCPM matrix and metadata dataframe are identical</span>
<span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setequal</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">logCPM_example</span><span class="op">)</span>, <span class="va">metadata_example</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] TRUE</span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># View sample metadata</span>
<span class="va">metadata_example</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html" class="external-link">datatable</a></span><span class="op">(</span>
        filter <span class="op">=</span> <span class="st">"top"</span>
    <span class="op">)</span></code></pre></div>
<div id="htmlwidget-be1be79e643305196bb9" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-be1be79e643305196bb9">{"x":{"filter":"top","vertical":false,"filterHTML":"<tr>\n  <td><\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"factor\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"width: 100%; display: none;\">\n      <select multiple=\"multiple\" style=\"width: 100%;\" data-options=\"[&quot;Vehicle&quot;,&quot;E2&quot;,&quot;E2+R5020&quot;,&quot;R5020&quot;]\"><\/select>\n    <\/div>\n  <\/td>\n  <td data-type=\"number\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"display: none;position: absolute;width: 200px;opacity: 1\">\n      <div data-min=\"24\" data-max=\"48\"><\/div>\n      <span style=\"float: left;\"><\/span>\n      <span style=\"float: right;\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36"],["Vehicle_N1_24","E2+R5020_N1_24","R5020_N1_24","Vehicle_N2_48","E2+R5020_N2_48","R5020_N2_48","Vehicle_N3_48","E2+R5020_N3_48","R5020_N3_48","Vehicle_N4_24","E2+R5020_N4_24","R5020_N4_24","Vehicle_P1_24","E2+R5020_P1_24","R5020_P1_24","Vehicle_P2_24","E2+R5020_P2_24","R5020_P2_24","Vehicle_P3_24","E2+R5020_P3_24","R5020_P3_24","Vehicle_P4_48","E2+R5020_P4_48","R5020_P4_48","Vehicle_P5_48","E2+R5020_P5_48","R5020_P5_48","Vehicle_P6_48","E2+R5020_P6_48","R5020_P6_48","Vehicle_P7_24","E2+R5020_P7_24","R5020_P7_24","Vehicle_P8_24","E2+R5020_P8_24","R5020_P8_24"],["N1","N1","N1","N2","N2","N2","N3","N3","N3","N4","N4","N4","P1","P1","P1","P2","P2","P2","P3","P3","P3","P4","P4","P4","P5","P5","P5","P6","P6","P6","P7","P7","P7","P8","P8","P8"],["Vehicle","E2+R5020","R5020","Vehicle","E2+R5020","R5020","Vehicle","E2+R5020","R5020","Vehicle","E2+R5020","R5020","Vehicle","E2+R5020","R5020","Vehicle","E2+R5020","R5020","Vehicle","E2+R5020","R5020","Vehicle","E2+R5020","R5020","Vehicle","E2+R5020","R5020","Vehicle","E2+R5020","R5020","Vehicle","E2+R5020","R5020","Vehicle","E2+R5020","R5020"],[24,24,24,48,48,48,48,48,48,24,24,24,24,24,24,24,24,24,24,24,24,48,48,48,48,48,48,48,48,48,24,24,24,24,24,24],["Negative","Negative","Negative","Negative","Negative","Negative","Negative","Negative","Negative","Negative","Negative","Negative","Positive","Positive","Positive","Positive","Positive","Positive","Positive","Positive","Positive","Positive","Positive","Positive","Positive","Positive","Positive","Positive","Positive","Positive","Positive","Positive","Positive","Positive","Positive","Positive"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>sample<\/th>\n      <th>patient<\/th>\n      <th>treatment<\/th>\n      <th>time<\/th>\n      <th>PR<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":4},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"orderCellsTop":true}},"evals":[],"jsHooks":[]}</script>
</div>
<div class="section level2">
<h2 id="compute-weighted-single-sample-logfcs-sslogfcs">Compute weighted single-sample logFCs (ssLogFCs)<a class="anchor" aria-label="anchor" href="#compute-weighted-single-sample-logfcs-sslogfcs"></a>
</h2>
<p>It is expected that the logCPM matrix will be filtered to remove
undetectable genes and normalised to correct for library sizes or other
systematic artefacts, such as gene length or GC contents prior to
applying this method. Filtration and normalisation has been performed on
the example dataset.</p>
<p>Before single-sample logFCs ssLogFCs can be computed, rownames of the
logCPM matrix need to be converted to <code>entrez ID</code>. This is
because all the pathway topology information retrieved will be in
<code>entrez ID</code>. The conversion can be achieved through
bioconductor packages <code>AnnotationHub</code> and
<code>ensembldb</code> as shown below.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"AnnotationHub"</span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocManager/man/install.html" class="external-link">install</a></span><span class="op">(</span><span class="st">"AnnotationHub"</span><span class="op">)</span>
<span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"ensembldb"</span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="fu">BiocManager</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/BiocManager/man/install.html" class="external-link">install</a></span><span class="op">(</span><span class="st">"ensembldb"</span><span class="op">)</span>
<span class="va">ah</span> <span class="op">&lt;-</span> <span class="fu">AnnotationHub</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/AnnotationHub/man/AnnotationHub-class.html" class="external-link">AnnotationHub</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">ah</span> <span class="op">&lt;-</span> <span class="fu">AnnotationHub</span><span class="fu">::</span><span class="fu">subset</span><span class="op">(</span><span class="va">ah</span>,<span class="va">genome</span> <span class="op">==</span> <span class="st">"GRCh38"</span> <span class="op">&amp;</span> <span class="va">title</span> <span class="op">==</span> <span class="st">"Ensembl 101 EnsDb for Homo sapiens"</span><span class="op">)</span>
<span class="va">ensDb</span> <span class="op">&lt;-</span> <span class="va">ah</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">logCPM_example</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu">ensembldb</span><span class="fu">::</span><span class="fu">mapIds</span><span class="op">(</span><span class="va">ensDb</span>, <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">logCPM_example</span><span class="op">)</span>, <span class="st">"ENTREZID"</span>, keytype <span class="op">=</span> <span class="st">"GENEID"</span><span class="op">)</span>
<span class="co"># Remove genes that couldn't be matched to entrez IDs</span>
<span class="va">logCPM_example</span> <span class="op">&lt;-</span> <span class="va">logCPM_example</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">logCPM_example</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">logCPM_example</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">##       E2+R5020_N1_24 E2+R5020_N2_48 E2+R5020_N3_48 E2+R5020_N4_24</span>
<span class="co">## 7105        4.494844       5.109147       5.217774       4.728174</span>
<span class="co">## 8813        5.030057       5.435571       5.307279       6.031353</span>
<span class="co">## 57147       3.496101       3.844185       3.427482       5.231663</span>
<span class="co">## 55732       2.287891       1.366069       1.713835       3.394704</span>
<span class="co">## 2268        3.686114       4.341791       5.066294       3.931659</span>
<span class="co">## 3075        6.087160       7.018977       5.119004       4.698111</span>
<span class="co">##       E2+R5020_P1_24 E2+R5020_P2_24 E2+R5020_P3_24 E2+R5020_P4_48</span>
<span class="co">## 7105        3.231498       5.224926       4.723179       4.741936</span>
<span class="co">## 8813        6.039195       5.703273       5.580964       5.275121</span>
<span class="co">## 57147       3.990408       3.341131       3.436969       4.486209</span>
<span class="co">## 55732       2.345997       2.516406       2.680406       3.147235</span>
<span class="co">## 2268        3.555797       3.063161       4.114420       3.911222</span>
<span class="co">## 3075        6.828691       6.276147       5.477955       4.928428</span>
<span class="co">##       E2+R5020_P5_48 E2+R5020_P6_48 E2+R5020_P7_24 E2+R5020_P8_24 R5020_N1_24</span>
<span class="co">## 7105        5.678579       5.434636       4.307171       4.601912    4.417928</span>
<span class="co">## 8813        5.533148       5.433474       5.111516       5.530114    5.406296</span>
<span class="co">## 57147       4.113434       3.965867       4.304904       5.083659    3.636115</span>
<span class="co">## 55732       2.438389       1.493969       3.550802       2.929043    1.790357</span>
<span class="co">## 2268        1.530079       3.796048       4.603410       2.766024    3.635736</span>
<span class="co">## 3075        5.564824       6.034606       5.183657       5.559527    6.822835</span>
<span class="co">##       R5020_N2_48 R5020_N3_48 R5020_N4_24 R5020_P1_24 R5020_P2_24 R5020_P3_24</span>
<span class="co">## 7105     4.695391    4.296947    4.782965    3.422699    4.648704    4.957277</span>
<span class="co">## 8813     5.508080    5.761449    5.940795    6.101206    5.710957    5.535784</span>
<span class="co">## 57147    4.343678    4.277160    5.498923    3.828934    3.861923    3.313544</span>
<span class="co">## 55732    2.471200    2.222948    3.513086    1.705889    2.923150    2.407177</span>
<span class="co">## 2268     4.388130    3.775364    3.831912    3.816610    3.184325    3.573986</span>
<span class="co">## 3075     5.846733    6.316553    4.213052    6.567201    5.509969    5.899461</span>
<span class="co">##       R5020_P4_48 R5020_P5_48 R5020_P6_48 R5020_P7_24 R5020_P8_24 Vehicle_N1_24</span>
<span class="co">## 7105     4.621193    5.118092    5.753488    4.440260    4.296015      4.853830</span>
<span class="co">## 8813     4.778775    5.461439    5.337263    5.302293    5.593356      5.189238</span>
<span class="co">## 57147    4.624768    3.802290    3.914067    4.303012    4.627386      3.592225</span>
<span class="co">## 55732    3.327889    2.594323    2.365653    3.912700    2.606028      2.053903</span>
<span class="co">## 2268     4.258518    3.044646    3.336565    4.285880    3.506735      3.527669</span>
<span class="co">## 3075     6.203806    6.421087    5.454211    5.304470    6.045549      7.011023</span>
<span class="co">##       Vehicle_N2_48 Vehicle_N3_48 Vehicle_N4_24 Vehicle_P1_24 Vehicle_P2_24</span>
<span class="co">## 7105       4.081669      4.673548      4.323644      3.787142      4.816472</span>
<span class="co">## 8813       6.847270      5.085197      5.715933      5.702573      5.579238</span>
<span class="co">## 57147      5.211258      3.601125      5.297381      3.549156      3.249103</span>
<span class="co">## 55732      2.111865      1.975589      3.310645      2.082021      2.693153</span>
<span class="co">## 2268       6.930587      5.309135      4.080317      4.018237      3.336988</span>
<span class="co">## 3075       5.247581      5.654712      4.796275      6.444562      5.805050</span>
<span class="co">##       Vehicle_P3_24 Vehicle_P4_48 Vehicle_P5_48 Vehicle_P6_48 Vehicle_P7_24</span>
<span class="co">## 7105       4.913486     4.6675553      5.484910      5.636142      4.368376</span>
<span class="co">## 8813       5.578217     5.2879311      5.379719      5.569880      5.207345</span>
<span class="co">## 57147      3.573986     5.1282714      3.549639      3.815933      4.244291</span>
<span class="co">## 55732      2.732106     2.4378931      2.368816      1.028753      3.440885</span>
<span class="co">## 2268       3.520109     2.9123235      3.029545      2.904204      4.639377</span>
<span class="co">## 3075       5.445898     0.9766637      5.927296      5.465367      5.474002</span>
<span class="co">##       Vehicle_P8_24</span>
<span class="co">## 7105       4.408367</span>
<span class="co">## 8813       5.606255</span>
<span class="co">## 57147      5.128891</span>
<span class="co">## 55732      3.201234</span>
<span class="co">## 2268       2.945421</span>
<span class="co">## 3075       5.411837</span></code></pre>
<p>To compute the ssLogFCs, samples must be in matching pairs. In the
example, treated samples are matched to the corresponding control sample
that were derived from the same patients. So the <code>factor</code>
parameter of the <code><a href="../reference/weight_ssFC.html">weight_ssFC()</a></code> functions needs to be set to
be “patient”. The function also requires the control treatment level to
be specified, which was “Vehicle” in this case.</p>
<p><code><a href="../reference/weight_ssFC.html">weight_ssFC()</a></code> requires both the logCPM matrix and sample
metadata as input. The column names of the logCPM matrix should be
sample name, matching to a column called <code>sample</code> in the
metadata. The metadata must also contain a treatment column, and a
column corresponding to the <code>factor</code> parameter (ie. patient
in this case).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#compute weighted single sample logFCs</span>
<span class="va">weightedFC</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/weight_ssFC.html">weight_ssFC</a></span><span class="op">(</span><span class="va">logCPM_example</span>, metadata <span class="op">=</span> <span class="va">metadata_example</span>,
factor <span class="op">=</span> <span class="st">"patient"</span>, control <span class="op">=</span> <span class="st">"Vehicle"</span><span class="op">)</span></code></pre></div>
<p>The <code><a href="../reference/weight_ssFC.html">weight_ssFC()</a></code> function firstly computes raw ssLogFCs
for each gene by subtracting logCPM values of control sample from the
logCPM values of treated samples for each patient.</p>
<p>It has been demonstrated previously that in RNA-seq data, lowly
expressed genes turn to have larger variance, which is also demonstrated
by the plots below. To reduce the impact of this artefact,
<code>weight_ssFC</code> also weight each ssLogFCs by estimating the
relationship between the variance in ssLogFCs and mean logCPM, and
defining the gene-wise weight to be the inverse of the predicted
variance of that gene’s mean logCPM value.</p>
<p>The ouput of the <code><a href="../reference/weight_ssFC.html">weight_ssFC()</a></code> function is a list with
two element, where one is the weighted ssLogFCs matrix and the other is
a vector of gene-wise weights.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">perSample_FC</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">metadata_example</span><span class="op">$</span><span class="va">patient</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
    <span class="va">temp</span> <span class="op">&lt;-</span> <span class="va">logCPM_example</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span>,<span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">logCPM_example</span><span class="op">)</span>, <span class="va">x</span><span class="op">)</span><span class="op">]</span> 
    <span class="va">ratio</span> <span class="op">&lt;-</span> <span class="va">temp</span><span class="op">[</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span>, <span class="st">"Vehicle"</span>, negate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">]</span> <span class="op">-</span> <span class="va">temp</span><span class="op">[</span>, <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/row_colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">temp</span><span class="op">)</span>, <span class="st">"Vehicle"</span><span class="op">)</span><span class="op">]</span> 
<span class="op">}</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">cbind</span>,<span class="va">.</span><span class="op">)</span>
<span class="va">aveCPM</span> <span class="op">&lt;-</span> <span class="va">logCPM_example</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">1000</span>,<span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/enframe.html" class="external-link">enframe</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"gene_id"</span>, 
            value <span class="op">=</span> <span class="st">"aveCPM"</span><span class="op">)</span>
<span class="va">p1</span> <span class="op">&lt;-</span> <span class="va">perSample_FC</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">rownames_to_column</a></span><span class="op">(</span><span class="st">"gene_id"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="op">-</span><span class="st">"gene_id"</span>,
                 names_to <span class="op">=</span> <span class="st">"name"</span>,
                 values_to <span class="op">=</span> <span class="st">"logFC"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">aveCPM</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">aveCPM</span>, <span class="va">logFC</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"sslogFC"</span>, 
         x <span class="op">=</span> <span class="st">"Average logCPM"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>
        panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>
    <span class="op">)</span>
<span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>
    gene_id <span class="op">=</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">perSample_FC</span><span class="op">)</span>,
    variance <span class="op">=</span> <span class="va">perSample_FC</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
        <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">var</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">aveCPM</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">aveCPM</span>, <span class="va">variance</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html" class="external-link">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"loess"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Variance in ssLogFCs"</span>, 
         x <span class="op">=</span> <span class="st">"Average logCPM"</span><span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>
        panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>
    <span class="op">)</span>
<span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1</span>, 
          <span class="va">p2</span><span class="op">)</span></code></pre></div>
<p><img src="sSNAPPY_files/figure-html/lowess-1.png" width="960"></p>
</div>
<div class="section level2">
<h2 id="retrieve-pathway-topologies-in-required-format">Retrieve pathway topologies in required format<a class="anchor" aria-label="anchor" href="#retrieve-pathway-topologies-in-required-format"></a>
</h2>
<p><em>sSNAPPY</em> adopts the pathway perturbation scoring algorithm
proposed in <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2732297/" class="external-link"><em>SPIA</em>
(Tarca AL et al. 2009)</a>, which makes use of gene-set topologise and
gene-gene interaction to propagate pathway genes’ logFCs down the
topologies to compute pathway perturbation scores, where signs of scores
reflect the potential directions of changes.</p>
<p>Therefore, pathway topology information need to be firstly retrieved
from your chosen database and converted to weight adjacency matrices,
the format required to apply the scoring algorithm. This step is
achieved through a chain of functions that are part of the <a href="https://bmcbioinformatics.biomedcentral.com/articles/10.1186/1471-2105-13-20" class="external-link"><em>graphite</em>
package (Sales G et al. 2012)</a> and has been nested into one simple
function in this package: <code><a href="../reference/weightedAdjMatrix.html">weightedAdjMatrix()</a></code>. Databases
that are currently supported are:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"graphite"</span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
    <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"graphite"</span><span class="op">)</span>
<span class="fu">graphite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/graphite/man/pathwayDatabases.html" class="external-link">pathwayDatabases</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">species</span> <span class="op">==</span>  <span class="st">"hsapiens"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
  <span class="fu">pander</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pander/man/pander.html" class="external-link">pander</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<table style="width:36%;" class="table">
<colgroup>
<col width="15%">
<col width="20%">
</colgroup>
<thead><tr class="header">
<th align="center">species</th>
<th align="center">database</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="center">hsapiens</td>
<td align="center">kegg</td>
</tr>
<tr class="even">
<td align="center">hsapiens</td>
<td align="center">panther</td>
</tr>
<tr class="odd">
<td align="center">hsapiens</td>
<td align="center">pathbank</td>
</tr>
<tr class="even">
<td align="center">hsapiens</td>
<td align="center">pharmgkb</td>
</tr>
<tr class="odd">
<td align="center">hsapiens</td>
<td align="center">reactome</td>
</tr>
<tr class="even">
<td align="center">hsapiens</td>
<td align="center">smpdb</td>
</tr>
<tr class="odd">
<td align="center">hsapiens</td>
<td align="center">wikipathways</td>
</tr>
</tbody>
</table>
<p>The retrieved topology information will be saved as an Rdata file in
the specified directory so this step only needs to be performed once for
each database. When loaded into the environment, the topologies will be
saved in a <code>list</code> called <code>gsTopology</code> by
default.</p>
<p>This vignette chose <em>KEGG</em> pathways as an example.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/weightedAdjMatrix.html">weightedAdjMatrix</a></span><span class="op">(</span>database <span class="op">=</span> <span class="st">"kegg"</span>, outputDir <span class="op">=</span> <span class="st">"gsTopology.rda"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/load.html" class="external-link">load</a></span><span class="op">(</span><span class="st">"gsTopology.rda"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">gsTopology</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] "Glycolysis / Gluconeogenesis"            </span>
<span class="co">## [2] "Citrate cycle (TCA cycle)"               </span>
<span class="co">## [3] "Pentose phosphate pathway"               </span>
<span class="co">## [4] "Pentose and glucuronate interconversions"</span>
<span class="co">## [5] "Fructose and mannose metabolism"         </span>
<span class="co">## [6] "Galactose metabolism"</span></code></pre>
<p>If only selected pathways are of interest, it’s possible to only
retrieve the topologeis of those pathways by specifying the pathway
names.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># weightedAdjMatrix( database = "kegg", pathwayName = c("Glycolysis / Gluconeogenesis", "Citrate cycle (TCA cycle)","Pentose phosphate pathway"), outputDir = "gsTopology.rda")</span>
<span class="co"># load("gsTopology.rda")</span>
<span class="co"># names(gsTopology)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="score-single-sample-pathway-perturbation">Score single sample pathway perturbation<a class="anchor" aria-label="anchor" href="#score-single-sample-pathway-perturbation"></a>
</h2>
<p>Once the expression matrix, sample metadata and pathway topologeis
are all ready, single sample pathway perturbation scores (PS) can be
computed using function <code><a href="../reference/perturbationScore.html">perturbationScore()</a></code>, which returns
a data.frame containing the test perturbation scores for each sample
each pathway.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ssPertScore</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/perturbationScore.html">perturbationScore</a></span><span class="op">(</span><span class="va">weightedFC</span><span class="op">$</span><span class="va">logFC</span>, <span class="va">gsTopology</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">ssPertScore</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">##           sample            tA                                   gs_name</span>
<span class="co">## 1 E2+R5020_N1_24 -0.0007226344 EGFR tyrosine kinase inhibitor resistance</span>
<span class="co">## 2    R5020_N1_24 -0.0004308462 EGFR tyrosine kinase inhibitor resistance</span>
<span class="co">## 3 E2+R5020_N2_48  0.0114266710 EGFR tyrosine kinase inhibitor resistance</span>
<span class="co">## 4    R5020_N2_48  0.0105650056 EGFR tyrosine kinase inhibitor resistance</span>
<span class="co">## 5 E2+R5020_N3_48  0.0016885212 EGFR tyrosine kinase inhibitor resistance</span>
<span class="co">## 6    R5020_N3_48  0.0041709149 EGFR tyrosine kinase inhibitor resistance</span></code></pre>
<div class="section level3">
<h3 id="correlations">Correlations?<a class="anchor" aria-label="anchor" href="#correlations"></a>
</h3>
</div>
</div>
<div class="section level2">
<h2 id="generate-null-distributions-of-perturbation-scores">Generate null distributions of perturbation scores<a class="anchor" aria-label="anchor" href="#generate-null-distributions-of-perturbation-scores"></a>
</h2>
<p>To derive the empirical p-values for each single sample PS or
normalize the raw scores for comparing overall treatment effects, null
distributions of scores for each pathway is generated through a
sample-label permutation approach.</p>
<p>For each round of permutation, sample labels are randomly shuffled to
derive the permuted ssLogFCs, which are then used to score pathway
perturbation. We recommend to perform a minimum of 1000 rounds of
permutation, which means at least 8 samples are required. The
<code><a href="../reference/generate_PermutedScore.html">generate_PermutedScore()</a></code> function does not require sample
metadata but the number of treatments in the study design, including the
control treatment, need to be specified. In this example data, the
number of treatment was 3.</p>
<p>Output of the <code><a href="../reference/generate_PermutedScore.html">generate_PermutedScore()</a></code> function is a
list where each element is a vector of permuted perturbation scores for
a pathway.</p>
<p>The permutation step relies on the parallel computing feature
provided by <code>BiocParallel</code>. User can choose to customize the
parallel back-end or stick with the default one returned by
<code><a href="https://rdrr.io/pkg/BiocParallel/man/register.html" class="external-link">BiocParallel::bpparam()</a></code>. Depending on the size of the data,
this step can take some time to complete. If the sample size is large,
we recommend users to consider performing this step on a HPC.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># permutedScore &lt;- generate_PermutedScore(logCPM_example, numOfTreat = 3, NB = 1000, gsTopology = gsTopology, weight = weightedFC$weight)</span></code></pre></div>
<p>Let’s randomly choose six pathways and examine the
permutation-derived emipirical distribution of their perturbation
scores. They should all be approximately normal distributed.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pl</span> <span class="op">&lt;-</span> <span class="va">permutedScore</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://purrr.tidyverse.org/reference/keep.html" class="external-link">keep</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">.</span><span class="op">!=</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="va">.</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span>, <span class="fl">6</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>mapping <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Perturbation Score"</span><span class="op">)</span>
    <span class="op">}</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressMessages</a></span><span class="op">(</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span>plotlist <span class="op">=</span> <span class="va">pl</span>, 
                           nrow <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="sSNAPPY_files/figure-html/NullDistribution-1.png" width="1344"></p>
<div class="section level3">
<h3 id="significance-of-individal-score">Significance of individal score<a class="anchor" aria-label="anchor" href="#significance-of-individal-score"></a>
</h3>
<p>After the empirical null distributions are generated, the median and
mad will be calculated for each pathway to convert the test
single-sample perturbation scores derived from the
<code><a href="../reference/perturbationScore.html">perturbationScore()</a></code> to robust z-scores: <span class="math display">\[ (Score - Median)/MAD\]</span> Two-sided p-values
associated with each robust z-scores are also computed and will be
corrected for multiple-testing using a user-define approach. The default
is <code>fdr</code>.</p>
<p>The pathways that were significant perturbed within individual
samples are:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">normalisedScores</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/normaliseByPermutation.html">normaliseByPermutation</a></span><span class="op">(</span><span class="va">permutedScore</span>, <span class="va">ssPertScore</span><span class="op">)</span>
<span class="va">normalisedScores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">adjPvalue</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">metadata_example</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="external-link">mutate_at</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sample"</span>, <span class="st">"gs_name"</span><span class="op">)</span><span class="op">)</span>, <span class="va">as.factor</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="external-link">mutate_if</a></span><span class="op">(</span><span class="va">is.numeric</span>, <span class="va">sprintf</span>, fmt <span class="op">=</span> <span class="st">'%#.4f'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Direction <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">robustZ</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="st">"Inhibited"</span>, <span class="st">"Activation"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>
        <span class="va">sample</span>,<span class="va">patient</span>, Treatment <span class="op">=</span> <span class="va">treatment</span>, `Perturbation Score` <span class="op">=</span> <span class="va">robustZ</span>, <span class="va">Direction</span>,
        `Gene-set name` <span class="op">=</span> <span class="va">gs_name</span>, 
        `P-value` <span class="op">=</span> <span class="va">pvalue</span>, 
        FDR <span class="op">=</span> <span class="va">adjPvalue</span>
    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html" class="external-link">datatable</a></span><span class="op">(</span>
        filter <span class="op">=</span> <span class="st">"top"</span>, 
        options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
            columnDefs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>targets <span class="op">=</span> <span class="st">"Direction"</span>, visible <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>
        <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
    <span class="fu"><a href="https://rdrr.io/pkg/DT/man/formatCurrency.html" class="external-link">formatStyle</a></span><span class="op">(</span>
        <span class="st">'Perturbation Score'</span>, <span class="st">'Direction'</span>,
        backgroundColor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/DT/man/styleInterval.html" class="external-link">styleEqual</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Inhibited"</span>, <span class="st">"Activation"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'lightblue'</span>, <span class="st">'indianred'</span><span class="op">)</span><span class="op">)</span>
    <span class="op">)</span></code></pre></div>
<div id="htmlwidget-c47f4c4d41d608f3cb08" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-c47f4c4d41d608f3cb08">{"x":{"filter":"top","vertical":false,"filterHTML":"<tr>\n  <td><\/td>\n  <td data-type=\"factor\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"width: 100%; display: none;\">\n      <select multiple=\"multiple\" style=\"width: 100%;\" data-options=\"[&quot;E2+R5020_N2_48&quot;,&quot;R5020_N2_48&quot;,&quot;R5020_P4_48&quot;]\"><\/select>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"factor\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"width: 100%; display: none;\">\n      <select multiple=\"multiple\" style=\"width: 100%;\" data-options=\"[&quot;Vehicle&quot;,&quot;E2&quot;,&quot;E2+R5020&quot;,&quot;R5020&quot;]\"><\/select>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"factor\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"width: 100%; display: none;\">\n      <select multiple=\"multiple\" style=\"width: 100%;\" data-options=\"[&quot;Alzheimer disease&quot;,&quot;Basal cell carcinoma&quot;,&quot;Circadian entrainment&quot;,&quot;Cushing syndrome&quot;,&quot;EGFR tyrosine kinase inhibitor resistance&quot;,&quot;Fanconi anemia pathway&quot;,&quot;Focal adhesion&quot;,&quot;Homologous recombination&quot;,&quot;Human papillomavirus infection&quot;,&quot;Long-term potentiation&quot;,&quot;Melanogenesis&quot;,&quot;Proteoglycans in cancer&quot;,&quot;Regulation of actin cytoskeleton&quot;,&quot;Renin secretion&quot;,&quot;Serotonergic synapse&quot;,&quot;Signaling pathways regulating pluripotency of stem cells&quot;,&quot;TGF-beta signaling pathway&quot;,&quot;Thermogenesis&quot;,&quot;Viral myocarditis&quot;]\"><\/select>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22"],["E2+R5020_N2_48","E2+R5020_N2_48","E2+R5020_N2_48","E2+R5020_N2_48","E2+R5020_N2_48","E2+R5020_N2_48","E2+R5020_N2_48","R5020_N2_48","R5020_N2_48","R5020_N2_48","R5020_N2_48","R5020_N2_48","R5020_P4_48","R5020_P4_48","R5020_P4_48","R5020_P4_48","R5020_P4_48","R5020_P4_48","R5020_P4_48","R5020_P4_48","R5020_P4_48","R5020_P4_48"],["N2","N2","N2","N2","N2","N2","N2","N2","N2","N2","N2","N2","P4","P4","P4","P4","P4","P4","P4","P4","P4","P4"],["E2+R5020","E2+R5020","E2+R5020","E2+R5020","E2+R5020","E2+R5020","E2+R5020","R5020","R5020","R5020","R5020","R5020","R5020","R5020","R5020","R5020","R5020","R5020","R5020","R5020","R5020","R5020"],["-4.0954","3.8165","3.1958","3.6129","-3.5405","3.6943","3.2329","-4.2039","3.4550","3.7225","3.6353","3.4550","3.5089","3.3485","-4.1454","3.8285","3.7889","3.0924","3.7528","3.3877","3.8052","3.2485"],["Inhibited","Activation","Activation","Activation","Inhibited","Activation","Activation","Inhibited","Activation","Activation","Activation","Activation","Activation","Activation","Inhibited","Activation","Activation","Activation","Activation","Activation","Activation","Activation"],["TGF-beta signaling pathway","Signaling pathways regulating pluripotency of stem cells","Melanogenesis","Cushing syndrome","Alzheimer disease","Proteoglycans in cancer","Basal cell carcinoma","TGF-beta signaling pathway","Focal adhesion","Signaling pathways regulating pluripotency of stem cells","Human papillomavirus infection","Proteoglycans in cancer","EGFR tyrosine kinase inhibitor resistance","Homologous recombination","Fanconi anemia pathway","Circadian entrainment","Thermogenesis","Long-term potentiation","Serotonergic synapse","Regulation of actin cytoskeleton","Renin secretion","Viral myocarditis"],["0.0000","0.0001","0.0014","0.0003","0.0004","0.0002","0.0012","0.0000","0.0006","0.0002","0.0003","0.0006","0.0004","0.0008","0.0000","0.0001","0.0002","0.0020","0.0002","0.0007","0.0001","0.0012"],["0.0091","0.0147","0.0432","0.0164","0.0173","0.0159","0.0432","0.0057","0.0239","0.0201","0.0201","0.0239","0.0163","0.0220","0.0074","0.0076","0.0076","0.0431","0.0076","0.0219","0.0076","0.0280"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>sample<\/th>\n      <th>patient<\/th>\n      <th>Treatment<\/th>\n      <th>Perturbation Score<\/th>\n      <th>Direction<\/th>\n      <th>Gene-set name<\/th>\n      <th>P-value<\/th>\n      <th>FDR<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":5,"visible":false},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"orderCellsTop":true,"rowCallback":"function(row, data, displayNum, displayIndex, dataIndex) {\nvar value=data[5]; $(this.api().cell(row, 4).node()).css({'background-color':value == \"Inhibited\" ? \"lightblue\" : value == \"Activation\" ? \"indianred\" : null});\n}"}},"evals":["options.rowCallback"],"jsHooks":[]}</script><div class="section level4">
<h4 id="visualisation">Visualisation<a class="anchor" aria-label="anchor" href="#visualisation"></a>
</h4>
<p>We can use the <code>plot_gsNetwork</code> function to visualise the
significantly perturbed biological pathways as networks, where edges
between gene-sets reflect how much overlap those two gene-sets share.
The function can take <code>normaliseByPermutation</code>’s output, or a
subset of it as its direct input.</p>
<p>Nodes in the network plots could be colored by the predicted
direction of perturbation (ie. sign of robust z-score):</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pl</span> <span class="op">&lt;-</span> <span class="va">normalisedScores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">adjPvalue</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span>f <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span>
        <span class="va">plot_gsNetwork</span>, 
        gsTopology <span class="op">=</span> <span class="va">gsTopology</span>, 
        colorBy <span class="op">=</span> <span class="st">"robustZ"</span>
        
    <span class="op">)</span>
<span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span>
    plotlist <span class="op">=</span> <span class="va">pl</span>, 
    nrow <span class="op">=</span> <span class="fl">1</span>
<span class="op">)</span></code></pre></div>
<p><img src="sSNAPPY_files/figure-html/sigGS_nt_zscore-1.png" width="1920"></p>
<p>Or pvalues:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pl</span> <span class="op">&lt;-</span> <span class="va">normalisedScores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">adjPvalue</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span>f <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">sample</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span>
        <span class="va">plot_gsNetwork</span>, 
        gsTopology <span class="op">=</span> <span class="va">gsTopology</span>, 
        colorBy <span class="op">=</span> <span class="st">"pvalue"</span>, 
        color_lg_title <span class="op">=</span> <span class="st">"P-value"</span>
    <span class="op">)</span>
<span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span>
    plotlist <span class="op">=</span> <span class="va">pl</span>, 
    nrow <span class="op">=</span> <span class="fl">1</span>
<span class="op">)</span></code></pre></div>
<p><img src="sSNAPPY_files/figure-html/sigGS_nt_pvalue-1.png" width="1920"></p>
<p>The function allows you to customize the layout, color, edge
transparency and other aesthetics of the graph. More information can be
found in the help page (<code><a href="../reference/plot_gsNetwork.html">?plot_gsNetwork</a></code>). Output of the
graph is a <code>ggplot</code> object and the theme of it can be changed
just as other <code>ggplot</code> figures.</p>
</div>
</div>
<div class="section level3">
<h3 id="significance-of-overall-treatment-effect">Significance of overall treatment effect<a class="anchor" aria-label="anchor" href="#significance-of-overall-treatment-effect"></a>
</h3>
<p>Normalised perturbation scores can also be used to model mean
treatment effects. An advantage of this method is that it has great
flexibility that allows you to incorporate other cofactors or covariate
in your modelling.</p>
<p>For example, in the example dataset, samples were collected from
patients with different progesteron receptor (PR) status and we can
include it as a cofactor to offset its confounding effect.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit</span> <span class="op">&lt;-</span> <span class="va">normalisedScores</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">metadata_example</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="external-link">mutate_at</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"time"</span>, <span class="st">"PR"</span><span class="op">)</span><span class="op">)</span>, <span class="va">as.factor</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span>f <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">gs_name</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="co">#.["Estrogen signaling pathway"] %&gt;%</span>
    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">robustZ</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">treatment</span> <span class="op">+</span> <span class="va">PR</span>, data <span class="op">=</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">summary</span><span class="op">)</span>
<span class="va">treat_sig</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
    <span class="va">fit</span><span class="op">[[</span><span class="va">x</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">coefficients</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
        <span class="fu"><a href="https://rdrr.io/pkg/BiocGenerics/man/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
        <span class="va">.</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>,<span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
        <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">Estimate</span>, 
                      pvalue <span class="op">=</span> <span class="va">`Pr(&gt;|t|)`</span> <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
        <span class="fu"><a href="https://tibble.tidyverse.org/reference/rownames.html" class="external-link">rownames_to_column</a></span><span class="op">(</span><span class="st">"Treatment"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>gs_name <span class="op">=</span> <span class="va">x</span>, 
               FDR <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/p.adjust.html" class="external-link">p.adjust</a></span><span class="op">(</span><span class="va">pvalue</span>, <span class="st">"fdr"</span><span class="op">)</span>, 
               Treatment <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_remove.html" class="external-link">str_remove_all</a></span><span class="op">(</span><span class="va">Treatment</span>, <span class="st">"treatment"</span><span class="op">)</span><span class="op">)</span> 
<span class="op">}</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="op">)</span> </code></pre></div>
<p>The pathways that were on average perturbed due to each treatment
were:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">treat_sig</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">FDR</span> <span class="op">&lt;</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="external-link">mutate_at</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Treatment"</span>, <span class="st">"gs_name"</span><span class="op">)</span><span class="op">)</span>, <span class="va">as.factor</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="external-link">mutate_if</a></span><span class="op">(</span><span class="va">is.numeric</span>, <span class="va">sprintf</span>, fmt <span class="op">=</span> <span class="st">'%#.4f'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Direction <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">Estimate</span> <span class="op">&lt;</span> <span class="fl">0</span>, <span class="st">"Inhibited"</span>, <span class="st">"Activation"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>
        <span class="va">Treatment</span>, `Perturbation Score` <span class="op">=</span> <span class="va">Estimate</span>, <span class="va">Direction</span>,
        `Gene-set name` <span class="op">=</span> <span class="va">gs_name</span>, 
        `P-value` <span class="op">=</span> <span class="va">pvalue</span>, 
        <span class="va">FDR</span>
    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="https://rdrr.io/pkg/DT/man/datatable.html" class="external-link">datatable</a></span><span class="op">(</span>
        filter <span class="op">=</span> <span class="st">"top"</span>, 
        options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>
            columnDefs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>targets <span class="op">=</span> <span class="st">"Direction"</span>, visible <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span>
        <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
    <span class="fu"><a href="https://rdrr.io/pkg/DT/man/formatCurrency.html" class="external-link">formatStyle</a></span><span class="op">(</span>
        <span class="st">'Perturbation Score'</span>, <span class="st">'Direction'</span>,
        backgroundColor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/DT/man/styleInterval.html" class="external-link">styleEqual</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Inhibited"</span>, <span class="st">"Activation"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'lightblue'</span>, <span class="st">'indianred'</span><span class="op">)</span><span class="op">)</span>
    <span class="op">)</span></code></pre></div>
<div id="htmlwidget-dae9e4ab2fb63f873ace" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-dae9e4ab2fb63f873ace">{"x":{"filter":"top","vertical":false,"filterHTML":"<tr>\n  <td><\/td>\n  <td data-type=\"factor\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"width: 100%; display: none;\">\n      <select multiple=\"multiple\" style=\"width: 100%;\" data-options=\"[&quot;E2+R5020&quot;,&quot;R5020&quot;]\"><\/select>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"factor\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n    <div style=\"width: 100%; display: none;\">\n      <select multiple=\"multiple\" style=\"width: 100%;\" data-options=\"[&quot;Acute myeloid leukemia&quot;,&quot;Aldosterone synthesis and secretion&quot;,&quot;Aldosterone-regulated sodium reabsorption&quot;,&quot;Cell adhesion molecules&quot;,&quot;Chemical carcinogenesis - reactive oxygen species&quot;,&quot;Cocaine addiction&quot;,&quot;Epstein-Barr virus infection&quot;,&quot;Estrogen signaling pathway&quot;,&quot;Gap junction&quot;,&quot;Insulin signaling pathway&quot;,&quot;Leishmaniasis&quot;,&quot;Long-term depression&quot;,&quot;Malaria&quot;,&quot;Mineral absorption&quot;,&quot;Neutrophil extracellular trap formation&quot;,&quot;Non-alcoholic fatty liver disease&quot;,&quot;Olfactory transduction&quot;,&quot;Pathways of neurodegeneration - multiple diseases&quot;,&quot;Pertussis&quot;,&quot;T cell receptor signaling pathway&quot;,&quot;TNF signaling pathway&quot;,&quot;Toxoplasmosis&quot;,&quot;Transcriptional misregulation in cancer&quot;,&quot;Yersinia infection&quot;]\"><\/select>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n  <td data-type=\"character\" style=\"vertical-align: top;\">\n    <div class=\"form-group has-feedback\" style=\"margin-bottom: auto;\">\n      <input type=\"search\" placeholder=\"All\" class=\"form-control\" style=\"width: 100%;\"/>\n      <span class=\"glyphicon glyphicon-remove-circle form-control-feedback\"><\/span>\n    <\/div>\n  <\/td>\n<\/tr>","data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35"],["E2+R5020","R5020","R5020","E2+R5020","R5020","E2+R5020","E2+R5020","E2+R5020","R5020","R5020","E2+R5020","R5020","E2+R5020","R5020","E2+R5020","E2+R5020","E2+R5020","E2+R5020","R5020","E2+R5020","R5020","E2+R5020","E2+R5020","E2+R5020","E2+R5020","E2+R5020","R5020","E2+R5020","R5020","R5020","E2+R5020","R5020","E2+R5020","R5020","E2+R5020"],["0.6614","0.5822","0.4047","0.9615","0.8756","-0.7436","-0.5413","-0.2631","-0.4134","0.5224","0.8709","1.0124","-0.8270","-0.6749","-0.4802","-0.5606","-0.8318","0.6284","0.7650","0.7206","0.9007","-0.7129","-0.6033","-0.7251","-0.7602","-0.5202","-0.4742","-0.5821","-0.3952","0.6993","-0.7389","-0.6130","-0.8436","-0.7326","-0.7019"],["Activation","Activation","Activation","Activation","Activation","Inhibited","Inhibited","Inhibited","Inhibited","Activation","Activation","Activation","Inhibited","Inhibited","Inhibited","Inhibited","Inhibited","Activation","Activation","Activation","Activation","Inhibited","Inhibited","Inhibited","Inhibited","Inhibited","Inhibited","Inhibited","Inhibited","Activation","Inhibited","Inhibited","Inhibited","Inhibited","Inhibited"],["Acute myeloid leukemia","Acute myeloid leukemia","Aldosterone synthesis and secretion","Aldosterone-regulated sodium reabsorption","Aldosterone-regulated sodium reabsorption","Cell adhesion molecules","Chemical carcinogenesis - reactive oxygen species","Cocaine addiction","Cocaine addiction","Epstein-Barr virus infection","Estrogen signaling pathway","Estrogen signaling pathway","Gap junction","Gap junction","Insulin signaling pathway","Leishmaniasis","Long-term depression","Malaria","Malaria","Mineral absorption","Mineral absorption","Neutrophil extracellular trap formation","Non-alcoholic fatty liver disease","Olfactory transduction","Pathways of neurodegeneration - multiple diseases","Pertussis","Pertussis","T cell receptor signaling pathway","T cell receptor signaling pathway","TNF signaling pathway","Toxoplasmosis","Toxoplasmosis","Transcriptional misregulation in cancer","Transcriptional misregulation in cancer","Yersinia infection"],["0.0224","0.0417","0.0130","0.0305","0.0468","0.0119","0.0185","0.0443","0.0030","0.0024","0.0090","0.0031","0.0064","0.0220","0.0216","0.0047","0.0137","0.0071","0.0016","0.0463","0.0151","0.0169","0.0157","0.0171","0.0218","0.0169","0.0277","0.0054","0.0474","0.0137","0.0124","0.0340","0.0006","0.0021","0.0190"],["0.0417","0.0417","0.0260","0.0468","0.0468","0.0238","0.0370","0.0443","0.0059","0.0047","0.0090","0.0061","0.0127","0.0220","0.0431","0.0094","0.0274","0.0071","0.0032","0.0463","0.0301","0.0338","0.0314","0.0343","0.0437","0.0277","0.0277","0.0108","0.0474","0.0273","0.0248","0.0340","0.0012","0.0021","0.0380"]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>Treatment<\/th>\n      <th>Perturbation Score<\/th>\n      <th>Direction<\/th>\n      <th>Gene-set name<\/th>\n      <th>P-value<\/th>\n      <th>FDR<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"targets":3,"visible":false},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false,"orderCellsTop":true,"rowCallback":"function(row, data, displayNum, displayIndex, dataIndex) {\nvar value=data[3]; $(this.api().cell(row, 2).node()).css({'background-color':value == \"Inhibited\" ? \"lightblue\" : value == \"Activation\" ? \"indianred\" : null});\n}"}},"evals":["options.rowCallback"],"jsHooks":[]}</script><div class="section level4">
<h4 id="visualisation-1">Visualisation<a class="anchor" aria-label="anchor" href="#visualisation-1"></a>
</h4>
<p>Results of <code>lm</code> can also be visualised using the
<code>plot_gsNetwork</code> function. We just need to change the name of
the <code>Estimate</code> column to <code>robustZ</code> to color the
networks by the predicted directionality.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">treat_sig</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> 
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">FDR</span> <span class="op">&lt;</span> <span class="fl">0.05</span>, <span class="va">Treatment</span> <span class="op">==</span> <span class="st">"R5020"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>robustZ <span class="op">=</span> <span class="va">Estimate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span>
    <span class="fu"><a href="../reference/plot_gsNetwork.html">plot_gsNetwork</a></span><span class="op">(</span>
        gsTopology <span class="op">=</span> <span class="va">gsTopology</span>, 
        colorBy <span class="op">=</span> <span class="st">"robustZ"</span>
    <span class="op">)</span> <span class="op">+</span>
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>
        panel.grid <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, 
        panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>
    <span class="op">)</span> </code></pre></div>
<p><img src="sSNAPPY_files/figure-html/unnamed-chunk-3-1.png" width="960"></p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li>Sales G, Calura E, Cavalieri D, Romualdi C (2012). “graphite - a
Bioconductor package to convert pathway topology to gene network.” BMC
Bioinformatics. <a href="https://bmcbioinformatics.biomedcentral.com/articles/10.1186/1471-2105-13-20" class="external-link uri">https://bmcbioinformatics.biomedcentral.com/articles/10.1186/1471-2105-13-20</a>.</li>
<li>Tarca, Adi Laurentiu et al. (2009). “A novel signaling pathway
impact analysis.” Bioinformatics vol. 25,1 : 75-82. <a href="doi:10.1093/bioinformatics/btn577" class="uri">doi:10.1093/bioinformatics/btn577</a>
</li>
</ul>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by <a href="https://github.com/Wenjun-Liu" class="external-link">Wenjun
Liu</a>.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a>
2.0.2.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
